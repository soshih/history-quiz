<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ­´å² å¹´å·ã‚¯ã‚¤ã‚º - é­”æ³•ã®ä¿®è¡Œ v3.0</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --text:#1b1f2a;
      --muted:#5c6477;
      --line:#d8def0;
      --primary:#2f6fed;
      --good:#1b8f3a;
      --warn:#d97706;
      --bad:#dc2626;
      --chip:#f1f3f8;
      --soft:#f3f5ff;
      --shadow:0 10px 28px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    }
    .wrap{max-width:860px;margin:0 auto;padding:18px;}
    .card{
      background:var(--card);
      border-radius:16px;
      padding:18px;
      box-shadow:var(--shadow);
    }

    /* Header banner (image-like) */
    .banner{
      border-radius:16px;
      padding:14px 14px 12px;
      background:
        radial-gradient(1200px 300px at 20% 0%, rgba(47,111,237,.20), transparent 60%),
        radial-gradient(900px 280px at 85% 10%, rgba(255,215,0,.16), transparent 55%),
        linear-gradient(135deg, #0f172a 0%, #111827 40%, #0b1224 100%);
      color:#fff;
      margin-bottom:14px;
      position:relative;
      overflow:hidden;
    }
    .banner .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    .banner h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px;}
    .banner .sub{font-size:13px;color:rgba(255,255,255,.8)}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:3px 10px;border-radius:999px;background:rgba(255,255,255,.12);
      font-size:12px;color:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.18);
      white-space:nowrap;
    }
    .wand{
      width:34px;height:34px;border-radius:12px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .wand svg{width:22px;height:22px;opacity:.95}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:820px){ .grid2{grid-template-columns: 1.15fr .85fr;} }

    h2{font-size:15px;margin:14px 0 10px;color:#1f2a44}
    .muted{color:var(--muted);font-size:13px}
    .panel{
      border:1px solid var(--line);
      background:linear-gradient(180deg, #f9faff 0%, #f6f8ff 100%);
      border-radius:14px;
      padding:12px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input{
      font-size:16px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      width:220px;
    }
    .narrow{width:160px}
    button{
      font-size:15px;
      padding:10px 14px;
      border-radius:12px;
      border:0;
      cursor:pointer;
    }
    .primary{background:var(--primary);color:#fff}
    .ghost{background:#eef2ff;color:#223a86}
    .danger{background:#ffebee;color:#8a1f1f}
    .tiny{font-size:13px;padding:8px 10px;border-radius:10px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background:var(--chip);border:1px solid #e5e8f3;
      font-size:12px;color:#3a4256;
      white-space:nowrap;
    }
    .msg{
      margin-top:10px;padding:12px;border-radius:12px;
      display:none;font-size:15px;border:1px solid transparent;
    }
    .ok{background:#ecfdf3;border-color:#bde8c9}
    .ng{background:#fff1f2;border-color:#f3c1c7}
    .hidden{display:none}
    .event{
      font-size:22px;line-height:1.55;
      padding:14px;border-radius:14px;
      background:var(--soft);
      border:1px solid #e2e8ff;
      margin:12px 0;
    }
    .meta{
      margin-top:12px;font-size:13px;color:var(--muted);
      display:flex;gap:14px;flex-wrap:wrap;
    }
    .kpi b{color:#111827}

    /* Level bar (30 segments) */
    .lvbar{display:flex;gap:4px;flex-wrap:nowrap;overflow:hidden}
    .seg{
      width:100%;height:10px;border-radius:999px;
      background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.18);
      flex:1 1 0;
    }
    .seg.on{background:linear-gradient(90deg, rgba(255,215,0,.95), rgba(47,111,237,.95)); border-color:rgba(255,255,255,.22)}
    .seg.mid{background:rgba(47,111,237,.35)}
    .seg.low{background:rgba(255,255,255,.10)}

    /* Mastery chips */
    .m-unk{background:#eef2ff;color:#223a86}
    .m-low{background:#fff7ed;color:#9a3412}
    .m-mid{background:#ecfeff;color:#155e75}
    .m-hi{background:#ecfdf3;color:#166534}
    .m-max{background:#fefce8;color:#854d0e}
    .divider{height:1px;background:#e7ebf6;margin:12px 0}

    /* Notebook list */
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    td{vertical-align:top}
    .rowcard{
      background:#fff;border:1px solid #e7ebf6;border-radius:14px;
      padding:10px 12px;
    }
    .qtitle{font-weight:700}
    .qsub{font-size:12px;color:var(--muted);margin-top:4px}
    .right{display:flex;justify-content:flex-end}
    .mono{font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">

    <!-- ===== Banner ===== -->
    <div class="banner">
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <div class="wand" aria-hidden="true">
            <!-- simple wizard-hat svg (original, non-copyright) -->
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M12 2c1.8 3.6 3.4 7.7 4.1 11.6.4 2.3-.3 4.2-2.1 5.2-1.4.8-2.7.8-4 0-1.8-1-2.5-2.9-2.1-5.2C8.6 9.7 10.2 5.6 12 2Z" stroke="white" stroke-width="1.4"/>
              <path d="M4 19.5c2.6-1.2 5.4-1.8 8-1.8s5.4.6 8 1.8" stroke="white" stroke-width="1.4" stroke-linecap="round"/>
              <path d="M9.5 9.5l1.2.7.6-1.2.6 1.2 1.2-.7-.7 1.2 1.2.6-1.2.6.7 1.2-1.2-.7-.6 1.2-.6-1.2-1.2.7.7-1.2-1.2-.6 1.2-.6-.7-1.2Z" fill="white" opacity=".9"/>
            </svg>
          </div>
          <div>
            <h1>æ­´å² å¹´å·ã‚¯ã‚¤ã‚ºï½œé­”æ³•ã®ä¿®è¡Œ</h1>
            <div class="sub">å‡ºæ¥äº‹ â†’ å¹´å·å…¥åŠ›ï¼ˆæ­£è§£ã™ã‚‹ã¨è‡ªå‹•ã§æ¬¡ã¸ï¼‰</div>
          </div>
        </div>

        <div class="row" style="gap:8px;">
          <span id="overallTitleBadge" class="badge">ç·åˆï¼š-</span>
          <span id="overallRateBadge" class="badge">æ­£ç­”ç‡ï¼š-</span>
        </div>
      </div>

      <div class="divider" style="background:rgba(255,255,255,.14);margin:12px 0;"></div>

      <div class="row" style="justify-content:space-between;align-items:flex-end;">
        <div style="min-width:240px;">
          <div class="sub" style="margin-bottom:6px;">ç·åˆãƒ¬ãƒ™ãƒ«ï¼ˆLv1ã€œ30ï¼‰</div>
          <div class="lvbar" aria-hidden="true">
            <!-- 30 segments -->
            <div class="seg" id="seg1"></div><div class="seg" id="seg2"></div><div class="seg" id="seg3"></div><div class="seg" id="seg4"></div><div class="seg" id="seg5"></div>
            <div class="seg" id="seg6"></div><div class="seg" id="seg7"></div><div class="seg" id="seg8"></div><div class="seg" id="seg9"></div><div class="seg" id="seg10"></div>
            <div class="seg" id="seg11"></div><div class="seg" id="seg12"></div><div class="seg" id="seg13"></div><div class="seg" id="seg14"></div><div class="seg" id="seg15"></div>
            <div class="seg" id="seg16"></div><div class="seg" id="seg17"></div><div class="seg" id="seg18"></div><div class="seg" id="seg19"></div><div class="seg" id="seg20"></div>
            <div class="seg" id="seg21"></div><div class="seg" id="seg22"></div><div class="seg" id="seg23"></div><div class="seg" id="seg24"></div><div class="seg" id="seg25"></div>
            <div class="seg" id="seg26"></div><div class="seg" id="seg27"></div><div class="seg" id="seg28"></div><div class="seg" id="seg29"></div><div class="seg" id="seg30"></div>
          </div>
        </div>

        <div class="row" style="gap:8px;">
          <span class="badge" id="streakBadge">é€£ç¶šæ­£è§£ï¼š-</span>
          <span class="badge" id="totalBadge">ç´¯è¨ˆï¼š-</span>
        </div>
      </div>
    </div>

    <!-- ===== Views ===== -->
    <div id="startView">
      <div class="grid2">
        <div class="panel">
          <h2>ã‚¹ã‚¿ãƒ¼ãƒˆè¨­å®š</h2>

          <div class="row">
            <input id="startYear" class="narrow" inputmode="numeric" placeholder="é–‹å§‹å¹´ï¼ˆä¾‹ï¼š57ï¼‰">
            <input id="endYear" class="narrow" inputmode="numeric" placeholder="çµ‚äº†å¹´ï¼ˆä¾‹ï¼š1485ï¼‰">
          </div>

          <div class="row" style="margin-top:10px;">
            <label class="chip">
              <input type="checkbox" id="randomToggle" checked>
              ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ
            </label>
            <label class="chip">
              <input type="checkbox" id="soundToggle" checked>
              åŠ¹æœéŸ³
            </label>
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="startBtn" class="primary">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button id="startAllBtn" class="ghost">å…¨å•ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button id="openNotebookBtn" class="ghost">ä¿®è¡Œãƒãƒ¼ãƒˆ</button>
          </div>

          <div id="startMsg" class="msg"></div>

          <div class="meta">
            <div class="kpi">ç™»éŒ²å•é¡Œæ•°ï¼š<b><span id="totalCount">0</span></b></div>
            <div class="kpi">ä»Šæ—¥ã®ãŠã™ã™ã‚ï¼š<b>ã€Œä¿®è¡Œãƒãƒ¼ãƒˆã€â†’ è‹¦æ‰‹ã ã‘ç·´ç¿’</b></div>
          </div>
        </div>

        <div class="panel">
          <h2>1å•ã”ã¨ã®å¾—æ„åº¦ï¼ˆè¡¨ç¤ºã®æ„å‘³ï¼‰</h2>
          <div class="row">
            <span class="chip m-unk">â” æœªåˆ¤å®šï¼ˆã¾ã ãƒ‡ãƒ¼ã‚¿ä¸è¶³ï¼‰</span>
            <span class="chip m-low">ğŸ§ª èª¿åˆä¸­ï¼ˆè¦ç·´ç¿’ï¼‰</span>
            <span class="chip m-mid">ğŸª„ ç¿’å¾—ä¸­ï¼ˆã‚ã¨å°‘ã—ï¼‰</span>
            <span class="chip m-hi">âœ¨ å®‰å®šï¼ˆã‹ãªã‚Šå¾—æ„ï¼‰</span>
            <span class="chip m-max">ğŸ† ãƒã‚¹ã‚¿ãƒ¼ï¼ˆå®Œå…¨ç¿’å¾—ï¼‰</span>
          </div>
          <div class="divider"></div>
          <div class="muted">
            â€»ã€Œç·åˆãƒ¬ãƒ™ãƒ«ã€ã¯å…¨ä½“ã®æˆç¸¾ã‹ã‚‰è¨ˆç®—ã—ã¾ã™ï¼ˆå•é¡Œã”ã¨ã®å°ã¨ã¯åˆ¥ã§ã™ï¼‰
          </div>
          <div class="row" style="margin-top:10px;">
            <button id="resetAllBtn" class="danger tiny">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Quiz ===== -->
    <div id="quizView" class="hidden">
      <div class="row" style="justify-content:space-between;align-items:flex-end;">
        <div>
          <div class="chip" id="modeChip">ãƒ¢ãƒ¼ãƒ‰ï¼š-</div>
          <div class="chip" id="qMasteryChip">å¾—æ„åº¦ï¼š-</div>
        </div>
        <div class="row">
          <button id="quitBtn" class="danger">é€”ä¸­ã§çµ‚äº†</button>
        </div>
      </div>

      <div id="event" class="event"></div>

      <div class="row">
        <input id="answer" inputmode="numeric" placeholder="å¹´å·ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼š57ï¼‰">
        <button id="checkBtn" class="primary">åˆ¤å®š</button>
      </div>

      <div id="message" class="msg"></div>

      <div class="meta">
        <div class="kpi">æ­£è§£ï¼š<b><span id="correct">0</span></b></div>
        <div class="kpi">ä¸æ­£è§£ï¼š<b><span id="wrong">0</span></b></div>
        <div class="kpi">é€²æ—ï¼š<b><span id="progress">-</span></b></div>
      </div>

      <div class="muted" style="margin-top:8px;">Enterã§åˆ¤å®šï¼ˆåˆ¤å®šå¾Œã¯è‡ªå‹•ã§æ¬¡ã¸ï¼‰</div>
    </div>

    <!-- ===== Result ===== -->
    <div id="resultView" class="hidden">
      <h2>çµæœ</h2>

      <div class="meta" style="font-size:14px;">
        <div class="kpi">æ­£è§£ï¼š<b><span id="rCorrect"></span></b></div>
        <div class="kpi">ä¸æ­£è§£ï¼š<b><span id="rWrong"></span></b></div>
        <div class="kpi">æ­£ç­”ç‡ï¼š<b><span id="rRate"></span>%</b></div>
        <div class="kpi">å•é¡Œæ•°ï¼š<b><span id="rTotal"></span></b></div>
      </div>

      <div class="divider"></div>

      <h2>é–“é•ãˆãŸå•é¡Œ</h2>
      <div id="noWrong" class="msg ok">é–“é•ã„ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ğŸ†</div>
      <ul id="wrongList"></ul>

      <div class="row" style="margin-top:12px;">
        <button id="retryWrongBtn" class="primary">é–“é•ã„ã ã‘å¾©ç¿’</button>
        <button id="retryAllBtn" class="ghost">åŒæ¡ä»¶ã§ã‚‚ã†ä¸€å›</button>
        <button id="openNotebookFromResultBtn" class="ghost">ä¿®è¡Œãƒãƒ¼ãƒˆ</button>
        <button id="backBtn" class="ghost">ã‚¹ã‚¿ãƒ¼ãƒˆã«æˆ»ã‚‹</button>
      </div>
    </div>

    <!-- ===== Notebook ===== -->
    <div id="notebookView" class="hidden">
      <h2>ä¿®è¡Œãƒãƒ¼ãƒˆï¼ˆå•é¡Œåˆ¥ã®å¾—æ„åº¦ï¼‰</h2>
      <div class="muted">å¾—æ„åº¦ã¯ã€Œå°ï¼‹æ­£ç­”ç‡ï¼‹å›æ•°ã€ã§è¡¨ç¤ºã—ã¾ã™ã€‚è‹¦æ‰‹ã ã‘ã‚’é¸ã‚“ã§ç‰¹è¨“ã§ãã¾ã™ã€‚</div>

      <div class="row" style="margin-top:10px;">
        <span class="chip" id="nbSummaryChip">-</span>
        <span class="chip" id="nbFilterChip">ãƒ•ã‚£ãƒ«ã‚¿ï¼š-</span>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="ghost" id="filterAllBtn">å…¨éƒ¨</button>
        <button class="ghost" id="filterLowBtn">ğŸ§ª èª¿åˆä¸­ã ã‘</button>
        <button class="ghost" id="filterMidBtn">ğŸª„ ç¿’å¾—ä¸­ã ã‘</button>
        <button class="ghost" id="filterHiBtn">âœ¨ å®‰å®šä»¥ä¸Š</button>
        <button class="primary" id="trainFromNotebookBtn">è¡¨ç¤ºä¸­ã‚’ç‰¹è¨“</button>
        <button class="ghost" id="closeNotebookBtn">æˆ»ã‚‹</button>
      </div>

      <div class="divider"></div>

      <div id="notebookEmpty" class="msg ng">è¡¨ç¤ºã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>

      <table id="nbTable"></table>
    </div>

  </div>
</div>

<!-- ===== Data ===== -->
<script src="./questions.js"></script>

<script>
/* =========================
   ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ãƒã‚§ãƒƒã‚¯
========================= */
const ALL = window.QUESTIONS || [];
if (!Array.isArray(ALL) || ALL.length === 0) {
  alert("questions.js ãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ã€‚index.html ã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã« questions.js ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
}

/* =========================
   ç·åˆLvã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ1..30ï¼‰
   â€»ã“ã“ã¯ã€Œã‚¯ã‚¤ã‚ºå…¨ä½“ã€ã®ç§°å·ã¨ã—ã¦ä½¿ç”¨
========================= */
const LEVEL_TITLES = {
  1:  { icon:"ğŸª„", group:"å‘ªæ–‡è¦‹ç¿’ã„", title:"æ–ã®æŒã¡æ–¹è¦‹ç¿’ã„" },
  2:  { icon:"ğŸª„", group:"å‘ªæ–‡è¦‹ç¿’ã„", title:"ç™ºéŸ³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­" },
  3:  { icon:"ğŸª„", group:"å‘ªæ–‡è¦‹ç¿’ã„", title:"é­”æ³•ã®åŸºç¤ä½“åŠ›ã¥ãã‚Š" },
  4:  { icon:"ğŸª„", group:"å‘ªæ–‡è¦‹ç¿’ã„", title:"è© å”±ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼" },
  5:  { icon:"ğŸª„", group:"å‘ªæ–‡è¦‹ç¿’ã„", title:"å‘ªæ–‡ã®èŠ½ãŒå‡ºãŸ" },
  6:  { icon:"ğŸª„", group:"å‘ªæ–‡è¦‹ç¿’ã„", title:"ãƒŸã‚¹ãŒæ¸›ã£ã¦ããŸ" },
  7:  { icon:"ğŸª„", group:"å‘ªæ–‡è¦‹ç¿’ã„", title:"æˆåŠŸã®ã‚³ãƒ„ç™ºè¦‹" },
  8:  { icon:"ğŸª„", group:"å‘ªæ–‡è¦‹ç¿’ã„", title:"å®‰å®šã¸ã®ç¬¬ä¸€æ­©" },
  9:  { icon:"ğŸª„", group:"å‘ªæ–‡è¦‹ç¿’ã„", title:"ã‚‚ã†ã™ãå…¥å­¦ãƒ¬ãƒ™ãƒ«" },
  10: { icon:"ğŸª„", group:"å‘ªæ–‡è¦‹ç¿’ã„", title:"å…¥å­¦æº–å‚™OK" },

  11: { icon:"ğŸ“˜", group:"ãƒ›ã‚°ãƒ¯ãƒ¼ãƒ„ç”Ÿ", title:"1å¹´ç”Ÿï¼šåŸºç¤å‘ªæ–‡ã‚¯ãƒ©ã‚¹" },
  12: { icon:"ğŸ“˜", group:"ãƒ›ã‚°ãƒ¯ãƒ¼ãƒ„ç”Ÿ", title:"1å¹´ç”Ÿï¼šæ­£ç¢ºã•ã‚¢ãƒƒãƒ—ä¸­" },
  13: { icon:"ğŸ“˜", group:"ãƒ›ã‚°ãƒ¯ãƒ¼ãƒ„ç”Ÿ", title:"2å¹´ç”Ÿï¼šå¾©ç¿’ãŒå¾—æ„" },
  14: { icon:"ğŸ“˜", group:"ãƒ›ã‚°ãƒ¯ãƒ¼ãƒ„ç”Ÿ", title:"2å¹´ç”Ÿï¼šã†ã£ã‹ã‚ŠãƒŸã‚¹å¯¾ç­–ä¸­" },
  15: { icon:"ğŸ“˜", group:"ãƒ›ã‚°ãƒ¯ãƒ¼ãƒ„ç”Ÿ", title:"3å¹´ç”Ÿï¼šå‘ªæ–‡ã®å®‰å®šæ„Ÿ" },
  16: { icon:"ğŸ“˜", group:"ãƒ›ã‚°ãƒ¯ãƒ¼ãƒ„ç”Ÿ", title:"3å¹´ç”Ÿï¼šè‹¦æ‰‹å…‹æœãƒ¢ãƒ¼ãƒ‰" },
  17: { icon:"ğŸ“˜", group:"ãƒ›ã‚°ãƒ¯ãƒ¼ãƒ„ç”Ÿ", title:"4å¹´ç”Ÿï¼šå®Ÿæˆ¦åŠ›ãŒã¤ã„ãŸ" },
  18: { icon:"ğŸ“˜", group:"ãƒ›ã‚°ãƒ¯ãƒ¼ãƒ„ç”Ÿ", title:"4å¹´ç”Ÿï¼šæˆåŠŸç‡ãŒé«˜ã„" },
  19: { icon:"ğŸ“˜", group:"ãƒ›ã‚°ãƒ¯ãƒ¼ãƒ„ç”Ÿ", title:"5å¹´ç”Ÿï¼šO.W.L.å¯¾ç­–ä¸­" },
  20: { icon:"ğŸ“˜", group:"ãƒ›ã‚°ãƒ¯ãƒ¼ãƒ„ç”Ÿ", title:"5å¹´ç”Ÿï¼šè©¦é¨“ã«å¼·ã„" },

  21: { icon:"âœ¨", group:"å„ªç­‰ç”Ÿ", title:"å„ªç­‰ç”Ÿï¼šã»ã¼ãƒãƒ¼ãƒŸã‚¹" },
  22: { icon:"âœ¨", group:"å„ªç­‰ç”Ÿ", title:"å„ªç­‰ç”Ÿï¼šã‚¹ãƒ”ãƒ¼ãƒ‰ã‚‚è‰¯ã„" },
  23: { icon:"âœ¨", group:"å„ªç­‰ç”Ÿ", title:"å„ªç­‰ç”Ÿï¼šèª¬æ˜ã¾ã§ã§ãã‚‹" },
  24: { icon:"âœ¨", group:"å„ªç­‰ç”Ÿ", title:"å„ªç­‰ç”Ÿï¼šå®‰å®šæ„Ÿãƒãƒ„ã‚°ãƒ³" },
  25: { icon:"âœ¨", group:"å„ªç­‰ç”Ÿ", title:"å„ªç­‰ç”Ÿï¼šå…ˆç”Ÿã«ã»ã‚ã‚‰ã‚Œã‚‹" },

  26: { icon:"ğŸ§™â€â™‚ï¸", group:"ç†Ÿç·´é­”æ³•ä½¿ã„", title:"ç†Ÿç·´ï¼šå¤±æ•—ã—ãªã„å‹" },
  27: { icon:"ğŸ§™â€â™‚ï¸", group:"ç†Ÿç·´é­”æ³•ä½¿ã„", title:"ç†Ÿç·´ï¼šé›£å•ã‚‚è½ã¡ç€ã„ã¦" },
  28: { icon:"ğŸ§™â€â™‚ï¸", group:"ç†Ÿç·´é­”æ³•ä½¿ã„", title:"ç†Ÿç·´ï¼šä¸€ç™ºæˆåŠŸãŒå¤šã„" },
  29: { icon:"ğŸ§™â€â™‚ï¸", group:"ç†Ÿç·´é­”æ³•ä½¿ã„", title:"ç†Ÿç·´ï¼šã»ã¼å®Œå…¨è© å”±" },

  30: { icon:"ğŸ†", group:"é­”æ³•ç•Œã®ãƒã‚¹ã‚¿ãƒ¼", title:"é­”æ³•ç•Œã®ãƒã‚¹ã‚¿ãƒ¼ï¼šå®Œå…¨ç¿’å¾—" },
};

/* =========================
   localStorage
========================= */
const LS_STATS_KEY = "hpHistoryQuiz_stats_v1";
const LS_PREF_KEY  = "hpHistoryQuiz_prefs_v1";

function loadStats(){
  try{
    const raw = localStorage.getItem(LS_STATS_KEY);
    const obj = raw ? JSON.parse(raw) : {};
    return (obj && typeof obj === "object") ? obj : {};
  }catch(e){
    return {};
  }
}
function saveStats(stats){
  try{ localStorage.setItem(LS_STATS_KEY, JSON.stringify(stats)); }catch(e){}
}
function loadPrefs(){
  try{
    const raw = localStorage.getItem(LS_PREF_KEY);
    const obj = raw ? JSON.parse(raw) : {};
    return (obj && typeof obj === "object") ? obj : {};
  }catch(e){
    return {};
  }
}
function savePrefs(p){
  try{ localStorage.setItem(LS_PREF_KEY, JSON.stringify(p)); }catch(e){}
}

/* =========================
   çŠ¶æ…‹
========================= */
let stats = loadStats(); // stats[qid] = {attempt, correct, wrong, streak}
let prefs = loadPrefs();

let pool = [];
let index = 0;
let correct = 0;
let wrong = 0;
let locked = false;
let wrongMap = new Map();

let useRandom = prefs.useRandom ?? true;
let soundOn   = prefs.soundOn ?? true;

let currentBaseIds = null; // retryç”¨ï¼ˆåŒæ¡ä»¶ã‚»ãƒƒãƒˆï¼‰

/* =========================
   DOM helper
========================= */
const $ = id => document.getElementById(id);

function normalizeYear(v){
  if(!v) return null;
  const h = String(v).replace(/[ï¼-ï¼™]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xfee0));
  const d = h.replace(/[^0-9]/g,"");
  return d ? Number(d) : null;
}
function shuffle(a){
  const b = a.slice();
  for(let i=b.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [b[i],b[j]]=[b[j],b[i]];
  }
  return b;
}
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

/* =========================
   åŠ¹æœéŸ³ï¼ˆè»½ã„ãƒ“ãƒ¼ãƒ—ï¼‰
========================= */
function beep(ok){
  if(!soundOn) return;
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.value = ok ? 880 : 220;
    g.gain.value = 0.05;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, ok ? 110 : 160);
  }catch(e){}
}

/* =========================
   1å•ã”ã¨ã®å¾—æ„åº¦ï¼ˆåˆ¥è¡¨ç¾ï¼‰
========================= */
function ensureStat(qid){
  if(!stats[qid]){
    stats[qid] = { attempt:0, correct:0, wrong:0, streak:0 };
  }
  return stats[qid];
}
function rateOf(st){
  if(!st || !st.attempt) return null;
  return st.correct / st.attempt;
}
function masteryInfo(qid){
  const st = ensureStat(qid);
  if(st.attempt < 3){
    return {icon:"â”", label:"æœªåˆ¤å®š", cls:"m-unk", detail:"ãƒ‡ãƒ¼ã‚¿ä¸è¶³"};
  }
  const r = rateOf(st);
  const pct = Math.round(r*100);

  // ã“ã“ã¯ã€Œå°ï¼‹ï¼…ã€ã¨ã—ã¦ä½¿ã†ï¼ˆç·åˆLvã¨ã¯åˆ¥ï¼‰
  if(r >= 0.95 && st.streak >= 3) return {icon:"ğŸ†", label:`ãƒã‚¹ã‚¿ãƒ¼ ${pct}%`, cls:"m-max", detail:`${st.correct}/${st.attempt}`};
  if(r >= 0.80) return {icon:"âœ¨", label:`å®‰å®š ${pct}%`, cls:"m-hi", detail:`${st.correct}/${st.attempt}`};
  if(r >= 0.60) return {icon:"ğŸª„", label:`ç¿’å¾—ä¸­ ${pct}%`, cls:"m-mid", detail:`${st.correct}/${st.attempt}`};
  return {icon:"ğŸ§ª", label:`èª¿åˆä¸­ ${pct}%`, cls:"m-low", detail:`${st.correct}/${st.attempt}`};
}

/* =========================
   ç·åˆãƒ¬ãƒ™ãƒ«ï¼ˆ1..30ï¼‰
   ï¼å…¨å•é¡Œã®é›†è¨ˆã‹ã‚‰ç®—å‡º
========================= */
function overallAggregate(){
  let totalAttempt=0, totalCorrect=0, totalWrong=0, sumStreak=0, maxStreak=0;
  for(const q of ALL){
    const st = stats[q.id];
    if(!st) continue;
    totalAttempt += st.attempt||0;
    totalCorrect += st.correct||0;
    totalWrong   += st.wrong||0;
    sumStreak    += st.streak||0;
    maxStreak = Math.max(maxStreak, st.streak||0);
  }
  return { totalAttempt, totalCorrect, totalWrong, sumStreak, maxStreak };
}

function computeOverallLevel(){
  const agg = overallAggregate();
  const a = agg.totalAttempt;
  const c = agg.totalCorrect;
  const rate = a ? (c / a) : 0;

  // base 1..30
  const base = 1 + Math.floor(rate * 29);

  // attempt gateï¼ˆãƒ‡ãƒ¼ã‚¿å°‘ãªã„æ™‚ã«ä¸Šé™ï¼‰
  let cap = 30;
  if(a <= 5) cap = 10;
  else if(a <= 15) cap = 20;
  else cap = 30;

  // bonus: é€£ç¶šæ­£è§£ã®æœ€å¤§å€¤ã§å¾®èª¿æ•´ï¼ˆæœ€å¤§+3ï¼‰
  const s = agg.maxStreak;
  let bonus = 0;
  if(s >= 5) bonus = 3;
  else if(s >= 3) bonus = 2;
  else if(s >= 2) bonus = 1;

  return clamp(Math.min(base, cap) + bonus, 1, 30);
}

function overallTitleText(level){
  const t = LEVEL_TITLES[level] || LEVEL_TITLES[1];
  return `Lv${level} ${t.icon}ã€Œ${t.title}ã€`;
}

/* =========================
   UIæ›´æ–°ï¼ˆãƒãƒŠãƒ¼ãƒ»ãƒ¡ã‚¿ï¼‰
========================= */
function updateBanner(){
  const agg = overallAggregate();
  const level = computeOverallLevel();
  const a = agg.totalAttempt;
  const c = agg.totalCorrect;
  const rate = a ? Math.round((c/a)*100) : 0;

  $("overallTitleBadge").textContent = `ç·åˆï¼š${overallTitleText(level)}`;
  $("overallRateBadge").textContent  = `æ­£ç­”ç‡ï¼š${rate}%`;
  $("streakBadge").textContent       = `é€£ç¶šæ­£è§£ï¼š${agg.maxStreak}`;
  $("totalBadge").textContent        = `ç´¯è¨ˆï¼š${c}/${a}ï¼ˆæ­£è§£/å‡ºé¡Œï¼‰`;

  // 30 segments
  for(let i=1;i<=30;i++){
    const el = $("seg"+i);
    el.className = "seg";
    if(i <= level) el.classList.add("on");
    else if(i <= Math.max(10, Math.ceil(level*0.6))) el.classList.add("mid");
    else el.classList.add("low");
  }
}

function updateQuizMeta(){
  $("correct").textContent = String(correct);
  $("wrong").textContent   = String(wrong);
  $("progress").textContent = pool.length ? `${index+1} / ${pool.length}` : "-";
}

function setMessage(type, html){
  const m = $("message");
  m.className = "msg " + (type==="ok" ? "ok" : "ng");
  m.innerHTML = html;
  m.style.display = "block";
}

function clearMessage(){
  const m = $("message");
  m.style.display = "none";
  m.innerHTML = "";
}

/* =========================
   ç”»é¢åˆ‡æ›¿
========================= */
function showView(name){
  for(const id of ["startView","quizView","resultView","notebookView"]){
    $(id).classList.add("hidden");
  }
  $(name).classList.remove("hidden");
}

/* =========================
   å‡ºé¡Œãƒ—ãƒ¼ãƒ«ç”Ÿæˆ
========================= */
function buildPool(baseQuestions){
  let arr = baseQuestions.slice();

  // ä¸¦ã³
  if(useRandom) arr = shuffle(arr);
  else arr.sort((a,b)=>a.year-b.year);

  return arr;
}

/* =========================
   ã‚¯ã‚¤ã‚ºé€²è¡Œ
========================= */
function showQuestion(){
  if(index >= pool.length){
    finishQuiz();
    return;
  }
  const q = pool[index];
  $("event").textContent = q.event;
  $("answer").value = "";
  $("answer").focus();
  locked = false;
  clearMessage();

  $("modeChip").textContent = `ãƒ¢ãƒ¼ãƒ‰ï¼š${useRandom ? "ãƒ©ãƒ³ãƒ€ãƒ " : "å¹´å·é †"} / ${pool.length}å•`;
  const mi = masteryInfo(q.id);
  $("qMasteryChip").className = `chip ${mi.cls}`;
  $("qMasteryChip").textContent = `å¾—æ„åº¦ï¼š${mi.icon} ${mi.label}ï¼ˆ${mi.detail}ï¼‰`;

  updateQuizMeta();
  updateBanner();
}

function checkAnswer(){
  if(locked) return;
  const q = pool[index];

  const y = normalizeYear($("answer").value);
  if(y === null){
    setMessage("ng", "æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š57ï¼‰");
    return;
  }

  locked = true;

  const st = ensureStat(q.id);
  st.attempt += 1;

  if(y === q.year){
    st.correct += 1;
    st.streak += 1;
    correct++;
    wrongMap.delete(q.id);

    beep(true);
    setMessage("ok", `â—‹ æ­£è§£ï¼ <b>${q.year}å¹´</b>`);
  }else{
    st.wrong += 1;
    st.streak = 0;
    wrong++;
    wrongMap.set(q.id, { id:q.id, event:q.event, year:q.year, lastInput:y });

    beep(false);
    setMessage("ng", `Ã— ä¸æ­£è§£ã€‚æ­£è§£ã¯ <b>${q.year}å¹´</b> ã§ã™ã€‚`);
  }

  // ä¿å­˜
  stats[q.id] = st;
  saveStats(stats);

  // é€”ä¸­ã®ã‚«ã‚¦ãƒ³ãƒˆå³åæ˜ 
  updateQuizMeta();
  updateBanner();

  // è‡ªå‹•ã§æ¬¡ã¸
  setTimeout(()=>{
    index++;
    showQuestion();
  }, 1050);
}

function finishQuiz(){
  showView("resultView");

  const total = pool.length || 0;
  const rate = total ? Math.round((correct/total)*100) : 0;

  $("rCorrect").textContent = String(correct);
  $("rWrong").textContent   = String(wrong);
  $("rTotal").textContent   = String(total);
  $("rRate").textContent    = String(rate);

  const ws = Array.from(wrongMap.values());
  const ul = $("wrongList");
  ul.innerHTML = "";

  if(ws.length === 0){
    $("noWrong").style.display = "block";
    $("retryWrongBtn").disabled = true;
    $("retryWrongBtn").style.opacity = 0.6;
  }else{
    $("noWrong").style.display = "none";
    $("retryWrongBtn").disabled = false;
    $("retryWrongBtn").style.opacity = 1;

    for(const item of ws){
      const mi = masteryInfo(item.id);
      const li = document.createElement("li");
      li.innerHTML = `${mi.icon} <b>${item.event}</b> â†’ æ­£è§£ï¼š<b>${item.year}å¹´</b>ï¼ˆå…¥åŠ›ï¼š${item.lastInput}ï¼‰`;
      ul.appendChild(li);
    }
  }

  updateBanner();
}

/* =========================
   ã‚¹ã‚¿ãƒ¼ãƒˆ / å†ã‚¹ã‚¿ãƒ¼ãƒˆ
========================= */
function startWithQuestions(baseQuestions){
  pool = buildPool(baseQuestions);
  index = 0;
  correct = 0;
  wrong = 0;
  locked = false;
  wrongMap = new Map();

  // retryç”¨ã«ã€ŒåŒæ¡ä»¶ã‚»ãƒƒãƒˆã€ã‚’ä¿æŒï¼ˆidã ã‘ï¼‰
  currentBaseIds = baseQuestions.map(x=>x.id);

  showView("quizView");
  showQuestion();
}

/* =========================
   ä¿®è¡Œãƒãƒ¼ãƒˆ
========================= */
let notebookFilter = "all"; // all | low | mid | hi

function notebookFilteredQuestions(){
  const out = [];
  for(const q of ALL){
    const mi = masteryInfo(q.id);
    if(notebookFilter === "low" && mi.icon !== "ğŸ§ª") continue;
    if(notebookFilter === "mid" && mi.icon !== "ğŸª„") continue;
    if(notebookFilter === "hi"  && !(mi.icon === "âœ¨" || mi.icon === "ğŸ†")) continue;
    out.push({q, mi, st: ensureStat(q.id)});
  }
  return out;
}

function renderNotebook(){
  const rows = notebookFilteredQuestions();

  $("nbFilterChip").textContent = `ãƒ•ã‚£ãƒ«ã‚¿ï¼š${
    notebookFilter==="all" ? "å…¨éƒ¨" :
    notebookFilter==="low" ? "ğŸ§ª èª¿åˆä¸­" :
    notebookFilter==="mid" ? "ğŸª„ ç¿’å¾—ä¸­" : "âœ¨ å®‰å®šä»¥ä¸Š"
  }`;

  // ã‚µãƒãƒª
  const agg = overallAggregate();
  const level = computeOverallLevel();
  const rate = agg.totalAttempt ? Math.round((agg.totalCorrect/agg.totalAttempt)*100) : 0;
  $("nbSummaryChip").textContent = `ç·åˆ ${overallTitleText(level)} / æ­£ç­”ç‡ ${rate}% / ç´¯è¨ˆ ${agg.totalCorrect}/${agg.totalAttempt}`;

  const table = $("nbTable");
  table.innerHTML = "";

  if(rows.length === 0){
    $("notebookEmpty").style.display = "block";
    return;
  }
  $("notebookEmpty").style.display = "none";

  // è‹¦æ‰‹ãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«ï¼šæœªåˆ¤å®šâ†’èª¿åˆä¸­â†’ç¿’å¾—ä¸­â†’å®‰å®šâ†’ãƒã‚¹ã‚¿ãƒ¼ ã®é †ã«ä¸¦ã¹ã‚‹
  const order = {"â”":0, "ğŸ§ª":1, "ğŸª„":2, "âœ¨":3, "ğŸ†":4};
  rows.sort((a,b)=>{
    const oa = order[a.mi.icon] ?? 9;
    const ob = order[b.mi.icon] ?? 9;
    if(oa !== ob) return oa - ob;
    // ãã‚Œã§ã‚‚åŒã˜ãªã‚‰æ­£ç­”ç‡ãŒä½ã„æ–¹ã‚’ä¸Šã¸
    const ra = rateOf(a.st) ?? -1;
    const rb = rateOf(b.st) ?? -1;
    return ra - rb;
  });

  for(const {q, mi, st} of rows){
    const r = rateOf(st);
    const pct = (st.attempt ? Math.round(r*100) : 0);

    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.innerHTML = `
      <div class="rowcard">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="qtitle">${mi.icon} <span class="mono">[${q.year}]</span> ${q.event}</div>
            <div class="qsub">å¾—æ„åº¦ï¼š<span class="chip ${mi.cls}" style="margin-left:6px;">${mi.icon} ${mi.label}</span>
              <span class="muted mono" style="margin-left:8px;">å‡ºé¡Œ ${st.attempt}å› / æ­£è§£ ${st.correct}å› / é€£ç¶šæ­£è§£ ${st.streak}</span>
            </div>
          </div>
          <div class="right">
            <button class="primary tiny" data-train-one="${q.id}">ã“ã®å‘ªæ–‡ã‚’ç‰¹è¨“</button>
          </div>
        </div>
      </div>
    `;
    tr.appendChild(td);
    table.appendChild(tr);
  }

  // 1å•ç‰¹è¨“
  table.querySelectorAll("[data-train-one]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const qid = btn.getAttribute("data-train-one");
      const base = ALL.filter(x => x.id === qid);
      startWithQuestions(base);
    });
  });
}

/* =========================
   ã‚¤ãƒ™ãƒ³ãƒˆ
========================= */
$("checkBtn").addEventListener("click", checkAnswer);
document.addEventListener("keydown", e=>{
  if(e.key === "Enter" && !$("quizView").classList.contains("hidden")){
    checkAnswer();
  }
});

$("quitBtn").addEventListener("click", ()=>{
  if(!confirm("é€”ä¸­ã§çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã“ã¾ã§ã®æˆç¸¾ã‚’è¡¨ç¤ºã—ã¾ã™ï¼‰")) return;
  finishQuiz();
});

$("startBtn").addEventListener("click", ()=>{
  const s = normalizeYear($("startYear").value);
  const e = normalizeYear($("endYear").value);

  useRandom = $("randomToggle").checked;
  soundOn   = $("soundToggle").checked;

  prefs.useRandom = useRandom;
  prefs.soundOn   = soundOn;
  savePrefs(prefs);

  if(s !== null && e !== null && s > e){
    $("startMsg").className = "msg ng";
    $("startMsg").textContent = "é–‹å§‹å¹´ãŒçµ‚äº†å¹´ã‚ˆã‚Šå¤§ãã„ã§ã™ã€‚";
    $("startMsg").style.display = "block";
    return;
  }

  const filtered = ALL.filter(q=>{
    if(s !== null && q.year < s) return false;
    if(e !== null && q.year > e) return false;
    return true;
  });

  if(filtered.length === 0){
    $("startMsg").className = "msg ng";
    $("startMsg").textContent = "è©²å½“ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“";
    $("startMsg").style.display = "block";
    return;
  }

  $("startMsg").style.display = "none";
  startWithQuestions(filtered);
});

$("startAllBtn").addEventListener("click", ()=>{
  useRandom = $("randomToggle").checked;
  soundOn   = $("soundToggle").checked;

  prefs.useRandom = useRandom;
  prefs.soundOn   = soundOn;
  savePrefs(prefs);

  $("startMsg").style.display = "none";
  startWithQuestions(ALL);
});

$("retryAllBtn").addEventListener("click", ()=>{
  // ç›´è¿‘ã®æ¡ä»¶ã‚»ãƒƒãƒˆã§å†å‡ºé¡Œï¼ˆãƒ©ãƒ³ãƒ€ãƒ ãªã‚‰å†ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰
  if(Array.isArray(currentBaseIds) && currentBaseIds.length){
    const ids = new Set(currentBaseIds);
    const base = ALL.filter(q => ids.has(q.id));
    startWithQuestions(base);
  }else{
    startWithQuestions(ALL);
  }
});

$("retryWrongBtn").addEventListener("click", ()=>{
  const ws = Array.from(wrongMap.values());
  if(ws.length === 0) return;
  const ids = new Set(ws.map(x=>x.id));
  const base = ALL.filter(q => ids.has(q.id));
  startWithQuestions(base);
});

$("backBtn").addEventListener("click", ()=>{
  showView("startView");
  updateBanner();
});

$("openNotebookBtn").addEventListener("click", ()=>{
  notebookFilter = "all";
  showView("notebookView");
  renderNotebook();
  updateBanner();
});
$("openNotebookFromResultBtn").addEventListener("click", ()=>{
  notebookFilter = "all";
  showView("notebookView");
  renderNotebook();
  updateBanner();
});
$("closeNotebookBtn").addEventListener("click", ()=>{
  // å…ƒã®ç”»é¢ã«æˆ»ã™ï¼šçµæœç”»é¢ãŒè¦‹ãˆã¦ã„ãŸãªã‚‰çµæœã¸ã€ãã†ã§ãªã‘ã‚Œã°ã‚¹ã‚¿ãƒ¼ãƒˆã¸
  // ã‚·ãƒ³ãƒ—ãƒ«ã«ã‚¹ã‚¿ãƒ¼ãƒˆã¸æˆ»ã™
  showView("startView");
  updateBanner();
});
$("filterAllBtn").addEventListener("click", ()=>{ notebookFilter="all"; renderNotebook(); });
$("filterLowBtn").addEventListener("click", ()=>{ notebookFilter="low"; renderNotebook(); });
$("filterMidBtn").addEventListener("click", ()=>{ notebookFilter="mid"; renderNotebook(); });
$("filterHiBtn").addEventListener("click", ()=>{ notebookFilter="hi"; renderNotebook(); });

$("trainFromNotebookBtn").addEventListener("click", ()=>{
  const rows = notebookFilteredQuestions().map(x=>x.q);
  if(rows.length === 0){
    alert("è¡¨ç¤ºä¸­ã®å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  // è¡¨ç¤ºä¸­ã®ã‚»ãƒƒãƒˆã§ç‰¹è¨“
  startWithQuestions(rows);
});

$("resetAllBtn").addEventListener("click", ()=>{
  if(!confirm("å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ï¼ˆå¾—æ„åº¦ãƒ»ç´¯è¨ˆï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
  stats = {};
  saveStats(stats);
  updateBanner();
  alert("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
});

/* =========================
   åˆæœŸåŒ–
========================= */
$("totalCount").textContent = String(ALL.length);
$("randomToggle").checked = useRandom;
$("soundToggle").checked  = soundOn;

updateBanner();
showView("startView");
</script>
</body>
</html>
