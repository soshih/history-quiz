<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>歴史 年号クイズ v2.1</title>
  <style>
    body {
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background:#f6f7fb; margin:0;
    }
    .wrap { max-width:760px; margin:0 auto; padding:20px; }
    .card { background:#fff; border-radius:14px; padding:20px; box-shadow:0 6px 20px rgba(0,0,0,.06); }
    h1 { font-size:18px; margin:0 0 12px; }
    h2 { font-size:16px; margin:18px 0 10px; }
    .event { font-size:22px; line-height:1.5; padding:14px; background:#f3f5ff; border-radius:12px; margin-bottom:14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input { font-size:18px; padding:10px 12px; border-radius:10px; border:1px solid #cfd3e3; }
    .narrow { width:160px; }
    button { font-size:16px; padding:10px 14px; border-radius:10px; border:0; cursor:pointer; }
    .primary { background:#2f6fed; color:#fff; }
    .ghost { background:#eef2ff; }
    .danger { background:#ffebee; }
    .msg { margin-top:12px; padding:12px; border-radius:10px; font-size:16px; display:none; }
    .ok { background:#e8f5e9; }
    .ng { background:#ffebee; }
    .meta { margin-top:14px; font-size:14px; color:#555; display:flex; gap:16px; flex-wrap:wrap; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#f1f3f8; font-size:12px; }
    .hidden { display:none; }
    ul { margin:8px 0 0; padding-left:18px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">

    <!-- ===== スタート画面 ===== -->
    <div id="startView">
      <h1>歴史 年号クイズ（スタート設定）</h1>

      <div class="row">
        <input id="startYear" class="narrow" inputmode="numeric" placeholder="開始年（例：57）">
        <input id="endYear" class="narrow" inputmode="numeric" placeholder="終了年（例：1485）">
      </div>

      <div class="row" style="margin-top:10px;">
        <label>
          <input type="checkbox" id="randomToggle" checked>
          ランダム出題
        </label>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="startBtn" class="primary">スタート</button>
        <button id="startAllBtn" class="ghost">全問スタート</button>
      </div>

      <div id="startMsg" class="msg"></div>

      <div class="meta">
        <div>登録問題数：<span id="totalCount">0</span></div>
      </div>
    </div>

    <!-- ===== クイズ画面 ===== -->
    <div id="quizView" class="hidden">
      <h1>
        年号クイズ
        <span id="orderBadge" class="badge"></span>
      </h1>

      <div id="event" class="event"></div>

      <div class="row">
        <input id="answer" inputmode="numeric" placeholder="年号を入力">
        <button id="checkBtn" class="primary">判定</button>
        <button id="quitBtn" class="danger">途中終了</button>
      </div>

      <div id="message" class="msg"></div>

      <div class="meta">
        <div>正解：<span id="correct">0</span></div>
        <div>不正解：<span id="wrong">0</span></div>
        <div>進捗：<span id="progress">-</span></div>
      </div>
    </div>

    <!-- ===== 結果画面 ===== -->
    <div id="resultView" class="hidden">
      <h1>結果</h1>

      <div class="meta">
        <div>正解：<b><span id="rCorrect"></span></b></div>
        <div>不正解：<b><span id="rWrong"></span></b></div>
        <div>正答率：<b><span id="rRate"></span>%</b></div>
        <div>問題数：<b><span id="rTotal"></span></b></div>
      </div>

      <h2>間違えた問題</h2>
      <div id="noWrong" class="msg ok">間違いはありませんでした！</div>
      <ul id="wrongList"></ul>

      <div class="row" style="margin-top:12px;">
        <button id="retryWrongBtn" class="primary">間違いだけ復習</button>
        <button id="retryAllBtn" class="ghost">同条件でもう一回</button>
        <button id="backBtn" class="ghost">スタートに戻る</button>
      </div>
    </div>

  </div>
</div>

<!-- ===== 問題データ（別ファイル）===== -->
<script src="./questions.js"></script>

<script>
/* ========= データ ========= */
const ALL = window.QUESTIONS || [];
if (!Array.isArray(ALL) || ALL.length === 0) {
  alert("questions.js が読み込めていません。index.html と同じ場所に questions.js があるか確認してください。");
}

/* ========= 状態 ========= */
let pool = [];
let index = 0;
let correct = 0;
let wrong = 0;
let locked = false;
let wrongMap = new Map();
let useRandom = true;

/* ========= ユーティリティ ========= */
const $ = id => document.getElementById(id);

function normalize(v){
  if(!v) return null;
  const h = String(v).replace(/[０-９]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xfee0));
  const d = h.replace(/[^0-9]/g,"");
  return d ? Number(d) : null;
}

function shuffle(a){
  const b = a.slice();
  for(let i=b.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [b[i],b[j]]=[b[j],b[i]];
  }
  return b;
}

function buildPool(base){
  let arr = base.slice();
  if (useRandom) arr = shuffle(arr);
  else arr.sort((a,b)=>a.year-b.year);
  return arr;
}

/* ★ 画面のメタ表示を更新（今回の修正ポイント） */
function updateQuizMeta(){
  $("correct").textContent = String(correct);
  $("wrong").textContent = String(wrong);
  $("progress").textContent = pool.length ? `${index + 1} / ${pool.length}` : "-";
  $("orderBadge").textContent = useRandom ? "ランダム" : "年号順";
}

function showMsg(type,text){
  const m=$("message");
  m.className="msg "+(type==="ok"?"ok":"ng");
  m.textContent=text;
  m.style.display="block";
}

/* ========= 画面切り替え ========= */
function showStart(){
  $("startView").classList.remove("hidden");
  $("quizView").classList.add("hidden");
  $("resultView").classList.add("hidden");
}
function showQuiz(){
  $("startView").classList.add("hidden");
  $("quizView").classList.remove("hidden");
  $("resultView").classList.add("hidden");
}
function showResult(){
  $("startView").classList.add("hidden");
  $("quizView").classList.add("hidden");
  $("resultView").classList.remove("hidden");
}

/* ========= クイズ進行 ========= */
function showQuestion(){
  if(index >= pool.length){ finish(); return; }

  $("event").textContent = pool[index].event;
  $("answer").value = "";
  $("answer").focus();
  $("message").style.display="none";
  locked = false;

  updateQuizMeta();
}

function check(){
  if(locked) return;

  const q = pool[index];
  const y = normalize($("answer").value);

  if(y === null){
    showMsg("ng","数字を入力してください");
    return;
  }

  locked = true;

  if(y === q.year){
    correct++;
    wrongMap.delete(q.id);
    showMsg("ok",`○ 正解！ ${q.year}年`);
  }else{
    wrong++;
    wrongMap.set(q.id,{...q,last:y});
    showMsg("ng",`× 不正解。正解は ${q.year}年`);
  }

  // ★ 判定直後にカウンタを更新（これが無かったため途中で増えなかった）
  updateQuizMeta();

  setTimeout(()=>{
    index++;
    showQuestion();
  }, 1000);
}

function finish(){
  showResult();

  $("rCorrect").textContent = String(correct);
  $("rWrong").textContent = String(wrong);
  $("rTotal").textContent = String(pool.length);
  $("rRate").textContent = pool.length ? String(Math.round(correct / pool.length * 100)) : "0";

  const list = $("wrongList");
  list.innerHTML = "";

  const ws = [...wrongMap.values()];
  $("noWrong").style.display = ws.length ? "none" : "block";

  ws.forEach(w=>{
    const li = document.createElement("li");
    li.textContent = `${w.event} → ${w.year}年（入力:${w.last}）`;
    list.appendChild(li);
  });
}

/* ========= スタート / 再スタート ========= */
function start(base){
  pool = buildPool(base);
  index = 0;
  correct = 0;
  wrong = 0;
  locked = false;
  wrongMap = new Map();

  showQuiz();
  updateQuizMeta();
  showQuestion();
}

/* ========= イベント ========= */
$("startBtn").onclick = () => {
  const s = normalize($("startYear").value);
  const e = normalize($("endYear").value);
  useRandom = $("randomToggle").checked;

  if (s !== null && e !== null && s > e) {
    $("startMsg").className = "msg ng";
    $("startMsg").textContent = "開始年が終了年より大きいです。";
    $("startMsg").style.display = "block";
    return;
  }

  const filtered = ALL.filter(q=>{
    if(s !== null && q.year < s) return false;
    if(e !== null && q.year > e) return false;
    return true;
  });

  if(filtered.length === 0){
    $("startMsg").className="msg ng";
    $("startMsg").textContent="該当する問題がありません";
    $("startMsg").style.display="block";
    return;
  }

  $("startMsg").style.display="none";
  start(filtered);
};

$("startAllBtn").onclick = () => {
  useRandom = $("randomToggle").checked;
  $("startMsg").style.display="none";
  start(ALL);
};

$("retryAllBtn").onclick = () => {
  // 「同条件」＝現在の pool の元データで再出題（ランダムなら再シャッフル）
  // poolは出題用の並び替え後なので、元データを復元するために id で ALL から取り直す
  const ids = new Set(pool.map(x => x.id));
  const base = ALL.filter(x => ids.has(x.id));
  start(base);
};

$("retryWrongBtn").onclick = () => {
  const ws = [...wrongMap.values()];
  if (ws.length === 0) return;
  // 間違いだけ復習（ランダム設定は維持）
  start(ws);
};

$("backBtn").onclick = () => {
  showStart();
};

$("checkBtn").onclick = check;

$("quitBtn").onclick = () => {
  if (!confirm("途中で終了しますか？\n（ここまでの成績を表示します）")) return;
  finish();
};

document.addEventListener("keydown", e => {
  if (e.key === "Enter" && !$("quizView").classList.contains("hidden")) check();
});

/* 初期表示 */
$("totalCount").textContent = String(ALL.length);
showStart();
</script>
</body>
</html>
